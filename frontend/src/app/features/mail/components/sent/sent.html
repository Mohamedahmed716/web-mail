<div class="sent-container">

  <!-- Left: Email List -->
  <div class="sent-list-section" [class.shrunk]="selectedEmail">

    <!-- Toolbar with Search -->
    <div class="toolbar">
      <div class="left-tools">
        <h2 class="page-title" *ngIf="selectedEmail || !searchQuery">
          Sent <span class="count-badge">{{ emails.length }}</span>
        </h2>

        <!-- Search Bar (hidden when email is selected) -->
        <div class="search-wrapper" *ngIf="!selectedEmail">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input
            type="text"
            class="search-input"
            placeholder="Search sent..."
            [(ngModel)]="searchQuery"
            (keyup.enter)="onSearch()">
          <button class="clear-search" *ngIf="searchQuery" (click)="clearSearch()">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>

      <div class="right-tools">
        <button class="icon-btn" title="Sort"><i class="fa-solid fa-arrow-down-wide-short"></i></button>
        <button class="icon-btn" title="Filter" (click)="openFilterModal()">
          <i class="fa-solid fa-filter"></i>
        </button>
        <button class="icon-btn" title="Refresh" (click)="loadEmails()">
          <i class="fa-solid fa-rotate-right"></i>
        </button>
      </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <div class="checkbox-wrapper">
        <input type="checkbox" id="selectAll">
        <label for="selectAll">Select all</label>
      </div>
      <div class="actions">
        <button class="text-btn danger">Delete</button>
      </div>
    </div>

    <!-- Email List -->
    @if (isLoading) {
      <div class="loading-state">
        <i class="fa-solid fa-spinner fa-spin"></i> Loading emails...
      </div>
    }
    @else if (errorMessage) {
      <div class="error-state">
        <i class="fa-solid fa-triangle-exclamation"></i> {{ errorMessage }}
      </div>
    }
    @else {
      <div class="email-list">

        @for (email of emails; track email.id) {

          <div class="email-item"
               (click)="selectEmail(email)"
               [class.active]="selectedEmail?.id === email.id">

            <div class="email-select" (click)="stopProp($event)">
              <input type="checkbox">
            </div>

            <div class="email-content">

              <div class="email-top-row">
                <span class="sender-name">To: {{ getReceiversList(email.receivers) }}</span>

                <span class="email-priority">
                @switch (email.priority) {
                  @case (5) {
                    <i class="fa-solid fa-circle-exclamation critical-priority" title="Critical Priority"></i>
                  }
                  @case (4) {
                    <i class="fa-solid fa-exclamation-circle urgent-priority" title="Urgent Priority"></i>
                  }
                  @case (3) {
                    <i class="fa-solid fa-exclamation-triangle high-priority" title="High Priority"></i>
                  }
                  @case (2) {
                    <i class="fa-solid fa-info-circle medium-priority" title="Medium Priority"></i>
                  }
                  @case (1) {
                    <i class="fa-solid fa-circle-dot low-priority" title="Low Priority"></i>
                  }
                  @default {
                    <i class="fa-solid fa-check-circle no-priority" title="No Priority"></i>
                  }
                }
              </span>

                <span class="email-time">{{ email.timestamp | date:'shortTime' }}</span>
              </div>

              <div class="email-subject">
                {{ email.subject }}
                <i *ngIf="email.attachmentNames?.length" class="fa-solid fa-paperclip clip-icon"></i>
              </div>

              <div class="email-snippet">
                {{ email.body }}
              </div>

            </div>
          </div>

        } @empty {
          <div class="empty-state">
            <i class="fa-regular fa-paper-plane empty-icon"></i>
            <p>No sent emails found.</p>
          </div>
        }

      </div>
    }

    <!-- Pagination -->
    <div class="pagination">
      <button (click)="changePage(-1)" [disabled]="currentPage === 1">
        <i class="fa-solid fa-chevron-left"></i> Prev
      </button>
      <span>{{ currentPage }} of {{ totalPages }}</span>
      <button (click)="changePage(1)" [disabled]="currentPage >= totalPages">
        Next <i class="fa-solid fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Right: Email Display -->
  @if (selectedEmail) {
    <div class="email-display-pane">
      <div class="detail-toolbar">
        <div class="dt-left">
          <button class="icon-btn close-view-btn" (click)="closeEmail()" title="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
          <span class="dt-subject">{{ selectedEmail.subject }}</span>
        </div>
        <div class="dt-right">
          <button class="icon-btn" title="Print"><i class="fa-solid fa-print"></i></button>
          <button class="icon-btn" title="Delete"><i class="fa-regular fa-trash-can"></i></button>
        </div>
      </div>

      <app-EmailDisplay [mail]="selectedEmail" [type]="'sent'"></app-EmailDisplay>
    </div>
  }

</div>

<!-- Filter Modal -->
<div class="filter-modal-overlay" *ngIf="showFilterModal" (click)="closeFilterModal()">
  <div class="filter-modal" (click)="stopProp($event)">

    <div class="filter-header">
      <h3>Filter Sent Emails</h3>
      <button class="close-btn" (click)="closeFilterModal()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="filter-body">

      <div class="filter-field">
        <label for="filterFrom">From</label>
        <input
          type="text"
          id="filterFrom"
          placeholder="sender@example.com"
          [(ngModel)]="filterCriteria.from">
      </div>

      <div class="filter-field">
        <label for="filterTo">To</label>
        <input
          type="text"
          id="filterTo"
          placeholder="recipient@example.com"
          [(ngModel)]="filterCriteria.to">
      </div>

      <div class="filter-field">
        <label for="filterSubject">Subject</label>
        <input
          type="text"
          id="filterSubject"
          placeholder="Enter subject keywords"
          [(ngModel)]="filterCriteria.subject">
      </div>

      <div class="filter-field">
        <label for="filterHasWords">Has the words</label>
        <input
          type="text"
          id="filterHasWords"
          placeholder="Enter keywords to find"
          [(ngModel)]="filterCriteria.hasWords">
      </div>

      <div class="filter-field">
        <label for="filterDoesntHave">Doesn't have</label>
        <input
          type="text"
          id="filterDoesntHave"
          placeholder="Enter words to exclude"
          [(ngModel)]="filterCriteria.doesntHave">
      </div>

      <div class="filter-field">
        <label for="filterDate">Date within</label>
        <select id="filterDate" [(ngModel)]="filterCriteria.dateWithin">
          <option value="1d">1 day</option>
          <option value="3d">3 days</option>
          <option value="1w" selected>1 week</option>
          <option value="2w">2 weeks</option>
          <option value="1m">1 month</option>
          <option value="3m">3 months</option>
          <option value="6m">6 months</option>
          <option value="1y">1 year</option>
        </select>
      </div>

    </div>

    <div class="filter-footer">
      <button class="filter-btn secondary" (click)="clearFilter()">Clear</button>
      <button class="filter-btn primary" (click)="applyFilter()">Apply Filter</button>
    </div>

  </div>
</div>
