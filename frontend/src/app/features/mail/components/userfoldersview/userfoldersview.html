<div class="sent-container">

    <div class="sent-list-section" [class.shrunk]="selectedEmail">

        <div class="toolbar">
            <div class="left-tools">
                <h2 class="page-title" *ngIf="selectedEmail || !searchQuery">
                    {{ currentFolderName }} <span class="count-badge">{{ emails.length }}</span>
                </h2>

                <div class="search-wrapper" *ngIf="!selectedEmail">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input
                        type="text"
                        class="search-input"
                        placeholder="Search {{ currentFolderName | lowercase }}..."
                        [(ngModel)]="searchQuery"
                        >
                    <button class="clear-search" *ngIf="searchQuery" (click)="clearSearch()">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>

            <div class="right-tools">
                <button class="icon-btn" title="Filter" (click)="openFilterModal()">
                    <i class="fa-solid fa-filter"></i>
                </button>
                <button class="icon-btn" title="Refresh" (click)="loadEmailsForFolder(currentFolderName.toLowerCase())">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>
        </div>

        <div class="action-bar">
            <div class="checkbox-wrapper">
                <input type="checkbox" id="selectAll" (change)="toggleSelectAll($event)"
                    [checked]="selectedEmailIds.length > 0 && selectedEmailIds.length === emails.length">
                <label for="selectAll">Select all</label>
            </div>

            <div class="actions">
                <div class="move-action-wrapper">
    <select id="moveFolderSelect" class="move-folder-select"
        (change)="handleMoveSelectionChange($event)" [disabled]="selectedEmailIds.length === 0">
        
        <option value="" disabled selected>Move ({{ selectedEmailIds.length }})</option>
        
        <option value="original">Move to Original Folder</option>

        @for (folder of folders; track folder) {
            @if (folder.toLowerCase() !== currentFolderName.toLowerCase()) {
                <option [value]="folder.toLowerCase()">Move to {{ folder }}</option>
            }
        }
    </select>
</div>
                <button class="text-btn danger" (click)="deleteSelected()" [disabled]="selectedEmailIds.length === 0">
                    Delete ({{ selectedEmailIds.length }})
                </button>
            </div>
        </div>

        @if (isLoading) {
            <div class="loading-state"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>
        } @else if (errorMessage) {
            <div class="error-state"><i class="fa-solid fa-triangle-exclamation"></i> {{ errorMessage }}</div>
        } @else {
            <div class="email-list">
                @for (email of emails; track email.id) {
                    <div class="email-item" (click)="selectEmail(email)" [class.active]="selectedEmail?.id === email.id">
                        <div class="email-select" (click)="stopProp($event)">
                            <input type="checkbox" [checked]="selectedEmailIds.includes(email.id)"
                                (change)="toggleSelectEmail(email.id, $event)">
                        </div>
                        <div class="email-content">
                            <div class="email-top-row">
                                <span class="sender-name">
                                    {{ currentFolderName === 'Sent' ? 'To: ' + getReceiversList(email.receivers) : email.sender }}
                                </span>
                                <span class="email-priority">
                                    @switch (email.priority) {
                                        @case (4) { <i class="fa-solid fa-circle-exclamation critical-priority"></i> }
                                        @case (3) { <i class="fa-solid fa-exclamation-triangle high-priority"></i> }
                                        @case (2) { <i class="fa-solid fa-info-circle medium-priority"></i> }
                                        @case (1) { <i class="fa-solid fa-circle-dot low-priority"></i> }
                                        @default { <i class="fa-solid fa-check-circle no-priority"></i> }
                                    }
                                </span>
                                <span class="email-time">{{ email.timestamp | date:'shortTime' }}</span>
                            </div>
                            <div class="email-subject">
                                {{ email.subject }}
                                <i *ngIf="email.attachmentNames?.length" class="fa-solid fa-paperclip clip-icon"></i>
                            </div>
                            <div class="email-snippet">{{ email.body }}</div>
                        </div>
                    </div>
                } @empty {
                    <div class="empty-state">
                        <i class="fa-regular fa-paper-plane empty-icon"></i>
                        <p>No emails found in {{ currentFolderName }}.</p>
                    </div>
                }
            </div>
        }

        <div class="pagination">
            <button (click)="changePage(-1)" [disabled]="currentPage === 1">Prev</button>
            <span>{{ currentPage }} of {{ totalPages }}</span>
            <button (click)="changePage(1)" [disabled]="currentPage >= totalPages">Next</button>
        </div>
    </div>

    @if (selectedEmail) {
        <div class="email-display-pane" *ngIf="selectedEmail">
    <div class="detail-toolbar">
        <div class="dt-left">
            <button class="icon-btn" (click)="closeEmail()"><i class="fa-solid fa-xmark"></i></button>
            <div class="header-text-group">
                <span class="dt-subject">{{ selectedEmail.subject }}</span>
                
                @if (selectedEmail.firstFolder) {
                    <span class="origin-tag">
                        <i class="fa-solid fa-folder-open"></i> From: {{ selectedEmail.firstFolder }}
                    </span>
                }
            </div>
        </div>
        </div>

    <app-EmailDisplay [mail]="selectedEmail" [type]="selectedEmail?.firstFolder?.toLowerCase()"></app-EmailDisplay>
</div>  
    }
</div>

<div class="filter-modal-overlay" *ngIf="showFilterModal" (click)="closeFilterModal()">
    <div class="filter-modal" (click)="stopProp($event)">
        <div class="filter-header">
            <h3>Filter {{ currentFolderName }}</h3>
            <button class="close-btn" (click)="closeFilterModal()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="filter-body">
            <div class="filter-field"><label>From</label><input type="text" [(ngModel)]="filterCriteria.from"></div>
            <div class="filter-field"><label>To</label><input type="text" [(ngModel)]="filterCriteria.to"></div>
            <div class="filter-field"><label>Subject</label><input type="text" [(ngModel)]="filterCriteria.subject"></div>
            <div class="filter-field">
                <label>Date within</label>
                <select [(ngModel)]="filterCriteria.dateWithin">
                    <option value="1w">1 week</option>
                    <option value="1m">1 month</option>
                </select>
            </div>

            <div class="filter-field">
                <label>Has attachment:</label>
                <select [(ngModel)]="filterCriteria.hasAttachment">
                    <option value="">Any</option>
                    <option value="true">With attachments</option>
                    <option value="false">Without attachments</option>
                </select>
            </div>
        </div>
        <div class="filter-footer">
            <button class="filter-btn secondary" (click)="clearFilter()">Clear</button>
            <button class="filter-btn primary" (click)="applyFilter()">Apply</button>
        </div>
    </div>
</div>